<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <!-- PWA & Mobile Meta Tags -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#0f172a">
    
    <!-- iOS Web App Capable -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Achieve-mate">
    
    <!-- Android/Chrome Web App Capable -->
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>Achieve-mate</title>

    <!-- Font Awesome & Google Fonts -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
    <!-- Embedded App Icon (SVG Base64) - Used for Favicon and iOS Home Screen -->
    <!-- Note: iOS handles the apple-touch-icon link best for home screen icons -->
    <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512' style='background:%236366f1'%3E%3Crect width='512' height='512' rx='100' fill='%236366f1'/%3E%3Cpath d='M416 192L256 128L96 192l32 12.8V320H96v32h64V217.6L256 256l96-38.4V352h32V204.8L416 192zM256 352c-44.2 0-80 26.9-80 60v36h160v-36c0-33.1-35.8-60-80-60z' fill='white'/%3E%3C/svg%3E">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 512 512'%3E%3Crect width='512' height='512' rx='100' fill='%236366f1'/%3E%3Cpath d='M416 192L256 128L96 192l32 12.8V320H96v32h64V217.6L256 256l96-38.4V352h32V204.8L416 192zM256 352c-44.2 0-80 26.9-80 60v36h160v-36c0-33.1-35.8-60-80-60z' fill='white'/%3E%3C/svg%3E">

    <!-- Embedded Web App Manifest (Optimized JSON) -->
    <!-- We encode the JSON to ensure special characters don't break the data URI -->
    <link rel="manifest" href='data:application/manifest+json;charset=utf-8,%7B%22name%22%3A%22Achieve-mate%22%2C%22short_name%22%3A%22Achieve%22%2C%22start_url%22%3A%22.%22%2C%22display%22%3A%22standalone%22%2C%22background_color%22%3A%22%230f172a%22%2C%22theme_color%22%3A%22%230f172a%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22data%3Aimage%2Fsvg%2Bxml%2C%253Csvg%20xmlns%3D%27http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%27%20viewBox%3D%270%200%20512%20512%27%20style%3D%27background%3A%25236366f1%27%253E%253Crect%20width%3D%27512%27%20height%3D%27512%27%20rx%3D%27100%27%20fill%3D%27%25236366f1%27%2F%253E%253Cpath%20d%3D%27M416%20192L256%20128L96%20192l32%2012.8V320H96v32h64V217.6L256%20256l96-38.4V352h32V204.8L416%20192zM256%20352c-44.2%200-80%2026.9-80%2060v36h160v-36c0-33.1-35.8-60-80-60z%27%20fill%3D%27white%27%2F%253E%253C%2Fsvg%253E%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fsvg%2Bxml%22%2C%22purpose%22%3A%22any%20maskable%22%7D%5D%7D'>

    <style>
        /* --- CORE STYLES --- */
        :root {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-card-hover: #334155;
            --bg-sidebar: #0f172a; 
            
            --primary: #6366f1;
            --primary-hover: #4f46e5;
            --accent: #fbbf24;
            --success: #10b981;
            --danger: #ef4444;
            
            --text-main: #f8fafc;
            --text-muted: #94a3b8;
            --border: #334155;
            
            --radius-lg: 16px;
            --radius-md: 12px;
            
            --font-main: 'Inter', sans-serif;
            --font-heading: 'Poppins', sans-serif;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; scrollbar-width: thin; scrollbar-color: var(--border) var(--bg-body); }
        
        html, body {
            width: 100%;
            max-width: 100%;
            overflow-x: hidden; /* PREVENTS SIDE ZOOM */
            overscroll-behavior-y: none;
        }

        body { 
            background-color: var(--bg-body); 
            color: var(--text-main); 
            font-family: var(--font-main); 
            line-height: 1.6; 
        }

        .app-wrapper { 
            display: flex; 
            min-height: 100vh; 
            min-height: 100dvh; 
            width: 100%;
            overflow-x: hidden;
        }

        /* Sidebar */
        .sidebar { width: 260px; background: var(--bg-sidebar); border-right: 1px solid var(--border); display: flex; flex-direction: column; padding: 1.5rem; position: fixed; height: 100vh; height: 100dvh; z-index: 50; transition: transform 0.3s ease; }
        .brand { display: flex; align-items: center; gap: 0.75rem; margin-bottom: 2.5rem; color: var(--primary); font-family: var(--font-heading); font-weight: 700; font-size: 1.25rem; }
        
        .nav-item { display: flex; align-items: center; gap: 1rem; padding: 0.875rem 1rem; border-radius: var(--radius-md); color: var(--text-muted); cursor: pointer; transition: all 0.2s ease; font-weight: 500; margin-bottom: 0.5rem; border-left: 3px solid transparent; }
        .nav-item:hover { background: var(--bg-card-hover); color: var(--text-main); }
        .nav-item.active { background: rgba(99, 102, 241, 0.1); color: var(--primary); border-left-color: var(--primary); box-shadow: 0 0 15px rgba(99, 102, 241, 0.1); }

        .sidebar-footer { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border); text-align: center; font-size: 0.8rem; color: var(--text-muted); }
        .creator-link { color: var(--accent); text-decoration: none; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; margin-top: 5px; transition: color 0.2s; }
        .creator-link:hover { color: var(--primary); }

        /* Main Content */
        .main-content { 
            flex: 1; 
            margin-left: 260px; 
            padding: 2rem; 
            max-width: 1600px; 
            padding-bottom: 120px; 
            width: 100%; /* Ensure it takes full width */
            overflow-x: hidden; /* Double protection against zoom */
        }

        /* Mobile Nav */
        .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; width: 100%; background: var(--bg-card); border-top: 1px solid var(--border); padding: 0 1rem; justify-content: space-around; z-index: 100; padding-bottom: env(safe-area-inset-bottom); height: 70px; align-items: center; }
        .mobile-nav-item { display: flex; flex-direction: column; align-items: center; gap: 4px; color: var(--text-muted); font-size: 0.7rem; padding: 8px 16px; cursor: pointer; transition: all 0.2s; border-radius: 12px; position: relative; }
        .mobile-nav-item i { font-size: 1.3rem; margin-bottom: 2px; transition: transform 0.2s; }
        .mobile-nav-item.active { color: #fff; }
        .mobile-nav-item.active i { color: var(--primary); transform: translateY(-2px); }
        .mobile-nav-item.active::after { content: ''; position: absolute; top: -10px; left: 50%; transform: translateX(-50%); width: 20px; height: 4px; background: var(--primary); border-radius: 0 0 4px 4px; box-shadow: 0 0 10px var(--primary); }

        /* Header */
        .page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem; flex-wrap: wrap; gap: 15px; }
        .header-right { display: flex; align-items: center; gap: 15px; }
        .greeting h1 { font-family: var(--font-heading); font-size: 1.75rem; font-weight: 600; line-height: 1.2; }
        
        .streak-badge { display: flex; align-items: center; gap: 0.75rem; background: rgba(251, 191, 36, 0.1); border: 1px solid rgba(251, 191, 36, 0.2); padding: 0.5rem 1rem; border-radius: 50px; cursor: pointer; transition: transform 0.2s; white-space: nowrap; height: fit-content; }
        .streak-count { font-weight: 700; color: var(--accent); font-size: 1.1rem; }
        
        .header-login-btn { background: var(--primary); color: white; padding: 0.5rem 1.2rem; border-radius: 20px; font-size: 0.9rem; font-weight: 600; border: none; cursor: pointer; display: flex; align-items: center; gap: 8px; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); transition: transform 0.2s; white-space: nowrap; }
        .header-login-btn:hover { transform: translateY(-2px); background: var(--primary-hover); }

        /* INSTALL APP BANNER (STICKY BOTTOM) */
        .install-banner { display: none; position: fixed; bottom: 85px; left: 50%; transform: translateX(-50%); width: 92%; max-width: 400px; background: linear-gradient(135deg, var(--primary), #818cf8); color: white; padding: 1rem; border-radius: var(--radius-lg); align-items: center; justify-content: space-between; gap: 1rem; cursor: pointer; animation: slideUp 0.5s ease; box-shadow: 0 10px 25px rgba(0,0,0,0.3); z-index: 90; }
        .install-text { font-size: 0.95rem; font-weight: 600; }
        .install-sub { font-size: 0.8rem; opacity: 0.9; }
        .install-icon-circle { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }

        /* INSTALL GUIDES */
        .ios-install-guide, .android-manual-guide { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%); background: var(--bg-card); padding: 1rem; border-radius: var(--radius-lg); border: 1px solid var(--accent); box-shadow: 0 10px 30px rgba(0,0,0,0.5); width: 90%; max-width: 350px; z-index: 200; display: none; animation: slideUp 0.3s ease; }
        .ios-install-guide::after, .android-manual-guide::after { content: ''; position: absolute; bottom: -10px; left: 50%; margin-left: -10px; border-width: 10px; border-style: solid; border-color: var(--bg-card) transparent transparent transparent; }
        @keyframes slideUp { from { transform: translate(-50%, 20px); opacity: 0; } to { transform: translate(-50%, 0); opacity: 1; } }

        /* User Badge */
        .user-badge-header { display:none; align-items:center; gap:10px; cursor:pointer; }
        .user-badge-avatar { width: 36px; height: 36px; background: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border: 2px solid var(--bg-card); box-shadow: 0 0 0 1px var(--border); flex-shrink: 0; }
        .user-badge-name { display: none; } 

        /* Components */
        .card { 
            background: var(--bg-card); 
            border: 1px solid var(--border); 
            border-radius: var(--radius-lg); 
            padding: 1.5rem; 
            margin-bottom: 1.5rem; 
            max-width: 100%; 
            box-sizing: border-box;
        }
        
        .card-title { font-family: var(--font-heading); font-size: 1.1rem; font-weight: 600; margin-bottom: 1.25rem; display: flex; align-items: center; justify-content: space-between; color: var(--text-main); }
        .card-title-group { display: flex; align-items: center; gap: 10px; }
        
        .btn { border: none; outline: none; cursor: pointer; font-family: var(--font-main); font-weight: 500; border-radius: var(--radius-md); padding: 0.75rem 1.5rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; font-size: 0.95rem; white-space: nowrap; }
        .btn-primary { background: var(--primary); color: white; }
        .btn-secondary { background: var(--bg-card-hover); color: var(--text-main); border: 1px solid var(--border); }
        .btn-danger { background: rgba(239, 68, 68, 0.1); color: var(--danger); border: 1px solid rgba(239, 68, 68, 0.2); }
        .btn-sm { padding: 0.4rem 0.8rem; font-size: 0.8rem; }
        .btn-icon-only { padding: 0.5rem; width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; color: var(--text-muted); background: transparent; flex-shrink: 0; }
        .btn-icon-only:hover { background: var(--bg-card-hover); color: var(--text-main); }
        .btn-link-external { color: var(--accent); border: 1px solid rgba(251, 191, 36, 0.2); background: rgba(251, 191, 36, 0.05); }
        .btn-link-external:hover { background: rgba(251, 191, 36, 0.1); color: #fff; border-color: var(--accent); }

        input, select, textarea { width: 100%; background: var(--bg-body); border: 1px solid var(--border); color: var(--text-main); padding: 0.75rem 1rem; border-radius: var(--radius-md); font-family: var(--font-main); font-size: 16px; transition: all 0.2s; }
        input:focus, textarea:focus { outline: none; border-color: var(--primary); background: var(--bg-card-hover); }
        input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* Auth Styles */
        .auth-container { width: 100%; max-width: 400px; text-align: center; padding: 2.5rem !important; border: 1px solid var(--border); box-shadow: 0 20px 50px -10px rgba(0,0,0,0.5); }
        @media (max-width: 480px) {
            .auth-container { padding: 1.5rem !important; width: 95%; border-radius: 20px; margin-top: 4rem; }
        }

        .auth-tabs { display: flex; margin-bottom: 2rem; background: var(--bg-body); padding: 4px; border-radius: 50px; border: 1px solid var(--border); position: relative; overflow: hidden; }
        .auth-tab { flex: 1; padding: 10px; border-radius: 40px; cursor: pointer; font-weight: 600; color: var(--text-muted); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 2; position: relative; }
        .auth-tab.active { color: white; }
        .tab-slider { position: absolute; top: 4px; left: 4px; width: calc(50% - 4px); height: calc(100% - 8px); background: var(--primary); border-radius: 40px; transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); z-index: 1; }
        .auth-tabs.signup-active .tab-slider { transform: translateX(100%); }

        .input-group { position: relative; margin-bottom: 1.2rem; text-align: left; }
        .input-group label { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 0.4rem; display: block; font-weight: 500; margin-left: 5px; }
        .input-group input { padding-left: 40px; }
        .input-icon { position: absolute; left: 12px; top: 38px; color: var(--text-muted); transition: color 0.2s; }
        .input-group input:focus + .input-icon { color: var(--primary); }
        .password-toggle { position: absolute; right: 12px; top: 38px; cursor: pointer; color: var(--text-muted); z-index: 10; }
        .password-toggle:hover { color: var(--primary); }
        .auth-btn-submit { width: 100%; padding: 1rem; border-radius: 12px; background: linear-gradient(135deg, var(--primary), var(--primary-hover)); color: white; font-weight: 600; border: none; cursor: pointer; font-size: 1rem; margin-top: 0.5rem; transition: transform 0.2s; }
        .auth-btn-submit:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(99, 102, 241, 0.4); }
        .auth-bottom-link { margin-top: 1.5rem; font-size: 0.85rem; color: var(--text-muted); border-top: 1px solid var(--border); padding-top: 1rem; }
        .auth-bottom-link a { color: var(--accent); text-decoration: none; font-weight: 600; cursor: pointer; }

        /* Toast Notifications */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 9999; display: flex; flex-direction: column; gap: 10px; width: 90%; max-width: 400px; pointer-events: none; }
        .toast { background: var(--bg-card); color: var(--text-main); padding: 12px 20px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); border: 1px solid var(--border); display: flex; align-items: center; gap: 12px; animation: slideDown 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); pointer-events: auto; }
        .toast.error { border-color: var(--danger); }
        .toast.success { border-color: var(--success); }
        .toast i { font-size: 1.2rem; }
        .toast.error i { color: var(--danger); }
        .toast.success i { color: var(--success); }
        @keyframes slideDown { from { transform: translateY(-50px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }

        /* XP LEVEL SYSTEM & VISUALS */
        .level-container { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.5rem; margin-bottom: 1.5rem; position: relative; overflow: hidden; box-sizing: border-box; max-width: 100%; }
        .level-circle-container { display: flex; justify-content: center; align-items: center; margin-bottom: 1rem; }
        .level-circle { position: relative; width: 120px; height: 120px; display: flex; align-items: center; justify-content: center; }
        .level-circle svg { width: 100%; height: 100%; transform: rotate(-90deg); }
        .level-circle circle { fill: none; stroke-width: 8; stroke-linecap: round; }
        .level-circle-bg { stroke: rgba(255,255,255,0.1); }
        .level-circle-fg { stroke: var(--accent); stroke-dasharray: 314; stroke-dashoffset: 314; transition: stroke-dashoffset 1s ease; }
        .level-circle-content { position: absolute; text-align: center; }
        .level-number-large { font-size: 2.2rem; font-weight: 700; color: white; line-height: 1; }
        .level-label-small { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; }
        .floating-xp { position: fixed; color: var(--accent); font-weight: bold; font-size: 1.2rem; pointer-events: none; z-index: 9999; animation: floatUpFade 1.5s forwards; text-shadow: 0 2px 10px rgba(0,0,0,0.5); }
        @keyframes floatUpFade { 0% { opacity:1; transform:translateY(0) scale(1); } 100% { opacity:0; transform:translateY(-50px) scale(1.2); } }

        /* Settings Grid - Improved for Mobile */
        .settings-grid { display: flex; flex-wrap: wrap; gap: 10px; }
        .settings-grid .btn { flex: 1 1 auto; min-width: 120px; } 

        /* Grids & Layouts */
        .grid-dashboard { display: grid; grid-template-columns: 1.3fr 0.7fr; gap: 1.5rem; }
        .grid-profile { display: grid; grid-template-columns: 320px 1fr; gap: 1.5rem; }
        .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; }

        .priority-item { display: flex; align-items: center; gap: 1rem; padding: 1rem; background: var(--bg-body); border: 1px solid var(--border); border-radius: var(--radius-md); transition: all 0.2s; cursor: pointer; margin-bottom: 0.75rem; }
        .priority-item:hover { border-color: var(--primary); transform: translateX(4px); }
        .priority-item.checked .priority-text { text-decoration: line-through; color: var(--text-muted); }
        .priority-checkbox { width: 24px; height: 24px; border-radius: 50%; border: 2px solid var(--text-muted); display: flex; align-items: center; justify-content: center; color: transparent; flex-shrink: 0; }
        .priority-item.checked .priority-checkbox { background: var(--success); border-color: var(--success); color: white; }

        .graph-container { display: flex; justify-content: space-between; align-items: flex-end; height: 180px; padding: 20px 10px 5px 10px; background: linear-gradient(to bottom, rgba(30,41,59,0.3), rgba(15,23,42,0.3)); border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); }
        .graph-col { flex: 1; display: flex; flex-direction: column; align-items: center; gap: 8px; height: 100%; justify-content: flex-end; }
        .graph-bar { width: 10px; background: linear-gradient(180deg, var(--primary) 0%, var(--primary-hover) 100%); border-radius: 20px; transition: height 0.8s; min-height: 4px; }
        .graph-label { font-size: 0.65rem; color: var(--text-muted); }

        /* Calendar */
        .cal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; font-size: 0.9rem; font-weight: 700; }
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; }
        .cal-day { aspect-ratio: 1; display: flex; align-items: center; justify-content: center; border-radius: 6px; font-size: 0.8rem; cursor: pointer; border: 1px solid transparent; position: relative; }
        .cal-day:hover { background: var(--bg-card-hover); border-color: var(--primary); }
        .cal-day.today { color: var(--accent); font-weight: bold; border-color: var(--accent); }
        .cal-day.has-data .cal-dot { width: 4px; height: 4px; border-radius: 50%; background: var(--success); position: absolute; bottom: 4px; }

        .activity-group { background: var(--bg-card-hover); border-radius: 8px; margin-bottom: 10px; border-left: 3px solid var(--text-muted); overflow: hidden; }
        .activity-group.type-study { border-color: var(--primary); }
        .activity-group.type-goal { border-color: var(--success); }
        .group-header { padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; font-size: 0.9rem; font-weight: 600; }
        .group-items { padding: 0 15px 10px 15px; display: none; font-size: 0.85rem; color: var(--text-muted); }
        .group-items.show { display: block; }
        
        /* Courses */
        .courses-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(340px, 1fr)); gap: 1.5rem; }
        .course-filter-container { display: flex; gap: 10px; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; overflow-x: auto; }
        .course-tab { background: none; border: none; color: var(--text-muted); font-weight: 600; font-size: 0.95rem; cursor: pointer; padding: 0.5rem 1rem; border-radius: 20px; transition: all 0.2s; white-space: nowrap; }
        .course-tab.active { background: var(--bg-card-hover); color: var(--text-main); }
        
        .course-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); overflow: hidden; transition: all 0.3s ease; display: flex; flex-direction: column; position: relative; }
        .course-card:hover { transform: translateY(-4px); border-color: var(--primary); box-shadow: 0 10px 30px -10px rgba(0,0,0,0.5); }
        .course-header { padding: 1.5rem; background: linear-gradient(to bottom right, rgba(30,41,59,1), rgba(15,23,42,1)); border-bottom: 1px solid var(--border); position: relative; cursor: pointer; }
        .course-header-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 1rem; margin-bottom: 0.5rem; }
        .course-badge { font-size: 0.7rem; padding: 0.25rem 0.75rem; border-radius: 20px; background: rgba(99, 102, 241, 0.1); color: var(--primary); border: 1px solid rgba(99, 102, 241, 0.2); font-weight: 600; text-transform: uppercase; }
        .course-title { font-family: var(--font-heading); font-size: 1.15rem; font-weight: 600; line-height: 1.4; display: flex; align-items: center; gap: 8px; flex: 1; }
        .course-title i { font-size: 0.9rem; opacity: 0.5; transition: transform 0.3s; margin-top: 3px; }
        .video-accordion.open ~ .course-header .course-title i { transform: rotate(180deg); color: var(--primary); opacity: 1; }
        .course-meta { font-size: 0.85rem; color: var(--text-muted); display: flex; gap: 1rem; margin-top: 0.5rem; }
        .course-progress-area { padding: 1rem 1.5rem; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .progress-text { display: flex; justify-content: space-between; font-size: 0.8rem; color: var(--text-muted); font-weight: 500; margin-top: 5px; }
        .video-accordion { max-height: 0; overflow: hidden; transition: max-height 0.4s ease; background: var(--bg-card); }
        .video-accordion.open { max-height: 400px; overflow-y: auto; }
        .course-actions-container { position: absolute; bottom: 15px; right: 15px; z-index: 5; display: flex; gap: 8px; }
        .course-edit-btn { background: var(--bg-card-hover); color: var(--text-muted); border: 1px solid var(--border); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.2s; }
        .course-edit-btn:hover { color: var(--text-main); border-color: var(--text-muted); transform: translateY(-2px); }

        /* Awards */
        .ach-filters { display: flex; gap: 10px; margin-bottom: 1.5rem; overflow-x: auto; white-space: nowrap; padding-bottom: 5px; }
        .ach-filter-btn { padding: 0.4rem 1rem; border-radius: 20px; border: 1px solid var(--border); background: var(--bg-body); color: var(--text-muted); cursor: pointer; font-size: 0.85rem; }
        .ach-filter-btn.active { background: var(--primary); color: white; border-color: var(--primary); }
        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 1rem; } /* Reduced min-width for better mobile fit */
        .ach-card { background: var(--bg-card); border: 1px solid var(--border); border-radius: var(--radius-lg); padding: 1.25rem; display: flex; gap: 1rem; align-items: center; opacity: 0.5; filter: grayscale(1); transition: all 0.3s; position: relative; flex-direction: column; text-align: center; }
        .ach-card.earned { opacity: 1; filter: grayscale(0); border-color: var(--accent); background: linear-gradient(135deg, var(--bg-card), rgba(251, 191, 36, 0.05)); transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        .ach-icon { font-size: 1.8rem; color: var(--text-muted); margin-bottom: 5px; }
        .ach-card.earned .ach-icon { color: var(--accent); text-shadow: 0 0 10px rgba(251,191,36,0.4); }
        .ach-info h4 { font-size: 0.9rem; margin-bottom: 2px; }
        .ach-info p { font-size: 0.7rem; color: var(--text-muted); }
        .ach-progress { height: 4px; background: rgba(255,255,255,0.1); margin-top: 8px; border-radius: 2px; overflow: hidden; width: 100%; }
        .ach-fill { height: 100%; background: var(--primary); width: 0%; }

        /* Modals */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(15, 23, 42, 0.9); backdrop-filter: blur(5px); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-overlay.active { display: flex; animation: fadeIn 0.2s; }
        .modal-box { background: var(--bg-card); width: 90%; max-width: 600px; border-radius: var(--radius-lg); border: 1px solid var(--border); padding: 2rem; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-lg { max-width: 800px; }

        .guide-step { margin-bottom: 1.5rem; display: flex; gap: 1rem; align-items: flex-start; }
        .guide-icon { width: 40px; height: 40px; background: rgba(99,102,241,0.2); color: var(--primary); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; flex-shrink: 0; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes confetti { 0% { transform: translateY(0) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }
        .confetti { position: fixed; top: 0; width: 8px; height: 8px; z-index: 2000; pointer-events: none; }

        /* --- RESPONSIVE FIXES --- */
        @media (max-width: 768px) {
            .sidebar { transform: translateX(-100%); }
            .main-content { margin-left: 0; padding: 1rem; padding-bottom: 100px; } /* Reduced padding */
            .mobile-nav { display: flex; }
            .grid-dashboard, .grid-profile, .grid-2, .courses-grid { grid-template-columns: 1fr; }
            .page-header { flex-direction: row; }
            .greeting h1 { font-size: 1.2rem; }
            
            /* FIX: PREVENT SETTINGS BUTTONS FROM BREAKING LAYOUT */
            .settings-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
            .settings-grid .btn { 
                width: 100%; margin: 0; padding: 0.8rem 0.5rem; font-size: 0.8rem; 
                flex-direction: column; gap: 5px; text-align: center; 
                white-space: normal; /* Allow text wrapping on buttons */
                line-height: 1.2;
            }
            .settings-grid .btn i { font-size: 1.2rem; margin-bottom: 2px; }

            /* FIX: CARD PADDING ON MOBILE */
            .card { padding: 1.25rem; }
            
            /* FIX: LEVEL CONTAINER */
            .level-container { padding: 1.25rem; }
        }
    </style>
</head>
<body>

    <!-- TOAST CONTAINER -->
    <div id="toast-container"></div>

    <!-- iOS Install Guide Overlay -->
    <div id="ios-install-guide" class="ios-install-guide">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="font-size:0.95rem; color:var(--primary);">Install App</h3>
            <button onclick="document.getElementById('ios-install-guide').style.display='none'" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem;">&times;</button>
        </div>
        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">Install this app on your iPhone for a better experience:</p>
        <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem; margin-bottom:5px;">
            1. Tap the <strong>Share</strong> button <i class="fas fa-share-square" style="color:var(--accent)"></i>
        </div>
        <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem;">
            2. Select <strong>Add to Home Screen</strong> <i class="fas fa-plus-square" style="color:var(--text-main)"></i>
        </div>
    </div>

    <!-- Android Manual Install Guide -->
    <div id="android-manual-guide" class="android-manual-guide">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
            <h3 style="font-size:0.95rem; color:var(--primary);">Install App</h3>
            <button onclick="document.getElementById('android-manual-guide').style.display='none'" style="background:none; border:none; color:var(--text-muted); font-size:1.2rem;">&times;</button>
        </div>
        <p style="font-size:0.85rem; color:var(--text-muted); margin-bottom:10px;">App store not available? Install directly from browser:</p>
        <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem; margin-bottom:5px;">
            1. Tap the <strong>Menu</strong> (3 dots) <i class="fas fa-ellipsis-v" style="color:var(--text-main)"></i>
        </div>
        <div style="display:flex; align-items:center; gap:10px; font-size:0.85rem;">
            2. Select <strong>Install App</strong> or <strong>Add to Home</strong> <i class="fas fa-download" style="color:var(--accent)"></i>
        </div>
    </div>

    <!-- Welcome Overlay -->
    <div id="welcome-overlay" class="modal-overlay">
        <div class="modal-box modal-lg">
            <div style="text-align: center; margin-bottom: 2rem;">
                <h2 style="color: var(--primary); font-family: var(--font-heading); font-size: 1.8rem;">Welcome to Achieve-mate</h2>
                <p style="color: var(--text-muted);">Your personal productivity companion</p>
            </div>
            
            <div class="guide-step">
                <div class="guide-icon"><i class="fas fa-chart-pie"></i></div>
                <div>
                    <h4 style="font-family:var(--font-heading)">Dashboard</h4>
                    <p style="color:var(--text-muted); font-size:0.9rem;">View your daily progress, consistency streaks, and quick stats.</p>
                </div>
            </div>
            
            <div class="guide-step">
                <div class="guide-icon"><i class="fas fa-play-circle"></i></div>
                <div>
                    <h4 style="font-family:var(--font-heading)">Courses & Playlists</h4>
                    <p style="color:var(--text-muted); font-size:0.9rem;">Create learning playlists, track video progress, and manage your studies.</p>
                </div>
            </div>
            
            <button class="btn btn-primary" style="width: 100%; padding: 1rem;" onclick="closeWelcomeGuide()">Get Started</button>
        </div>
    </div>

    <!-- Manage Goals Modal -->
    <div id="manageGoalsModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-title">
                <div class="card-title-group"><i class="fas fa-tasks"></i> Manage Today's Goals</div>
                <button class="btn-icon-only" onclick="closeModal('manageGoalsModal')">✕</button>
            </div>
            <div style="display: flex; gap: 10px; margin-bottom: 1.5rem;">
                <input type="text" id="newGoalInput" placeholder="Add a new task...">
                <button class="btn btn-primary" onclick="addGoal()">Add</button>
            </div>
            <div id="manageGoalsList"></div>
        </div>
    </div>

    <!-- Add Playlist Modal -->
    <div id="addPlaylistModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-title">
                <div class="card-title-group"><i class="fas fa-plus"></i> Add New Course</div>
                <button class="btn-icon-only" onclick="closeModal('addPlaylistModal')">✕</button>
            </div>
            <form id="addCourseForm" onsubmit="savePlaylist(event)">
                <div class="input-group">
                    <label>Course Name</label>
                    <input type="text" id="plName" required placeholder="e.g., Machine Learning A-Z">
                </div>
                <div class="input-group">
                    <label>Source (Platform)</label>
                    <select id="plSource">
                        <option value="Udemy">Udemy</option>
                        <option value="YouTube">YouTube</option>
                        <option value="Coursera">Coursera</option>
                        <option value="Other">Other</option>
                    </select>
                </div>
                <div class="input-group">
                    <label>Course Link (Optional)</label>
                    <input type="url" id="plLink" placeholder="https://...">
                </div>
                <div class="input-group">
                    <label>Video Titles (One per line)</label>
                    <textarea id="plVideos" rows="5" placeholder="Intro to Python&#10;Setup Environment&#10;Variables & Data Types"></textarea>
                </div>
                <button type="submit" class="btn btn-primary" style="width:100%">Create Course</button>
            </form>
        </div>
    </div>

    <!-- Edit Playlist Modal -->
    <div id="editPlaylistModal" class="modal-overlay">
        <div class="modal-box">
            <div class="card-title">
                <div class="card-title-group"><i class="fas fa-edit"></i> Edit Course</div>
                <button class="btn-icon-only" onclick="closeModal('editPlaylistModal')">✕</button>
            </div>
            <input type="hidden" id="editPlId">
            <div class="input-group">
                <label>Course Name</label>
                <input type="text" id="editPlName">
            </div>
            <div class="input-group">
                <label>Course Link</label>
                <input type="url" id="editPlLink">
            </div>
            <div class="input-group">
                <label>Video Titles (One per line)</label>
                <textarea id="editPlVideos" rows="5"></textarea>
            </div>
            <div style="display: flex; gap: 1rem;">
                <button class="btn btn-primary" style="flex:1" onclick="updatePlaylist()">Save Changes</button>
                <button class="btn btn-danger" onclick="deletePlaylist()"><i class="fas fa-trash"></i></button>
            </div>
        </div>
    </div>

    <!-- Focus Overlay -->
    <div id="focus-overlay" class="modal-overlay" style="background: #0f172a; z-index: 2000;">
        <div style="text-align: center;">
            <div style="font-size: 1.5rem; color: var(--text-muted); margin-bottom: 1rem;">Focusing on</div>
            <h1 id="overlayTask" style="font-size: 2.5rem; margin-bottom: 3rem; font-family: var(--font-heading); word-break: break-word; padding: 0 1rem;">Deep Work</h1>
            <div id="overlayTimer" style="font-size: 6rem; font-weight: 700; font-variant-numeric: tabular-nums; color: var(--primary); margin-bottom: 3rem;">25:00</div>
            <button class="btn btn-danger" onclick="stopFullScreenFocus()" style="padding: 1rem 3rem; font-size: 1.2rem; border-radius: 50px;">Stop Session</button>
        </div>
    </div>

    <!-- Auth Overlay -->
    <div id="auth-overlay" class="modal-overlay">
        <div class="modal-box auth-container">
            <button class="btn-icon-only" onclick="document.getElementById('auth-overlay').classList.remove('active')" style="position:absolute; top:15px; right:15px;">✕</button>
            
            <h2 style="margin-bottom: 0.5rem; color: var(--primary); font-family: var(--font-heading);">Welcome Back</h2>
            <p style="color: var(--text-muted); margin-bottom: 1.5rem; font-size: 0.9rem;">Sync your goals across devices</p>
            
            <div class="auth-tabs" id="authTabsContainer">
                <div class="tab-slider"></div>
                <div class="auth-tab active" id="tab-login" onclick="toggleAuthMode('login')">Login</div>
                <div class="auth-tab" id="tab-signup" onclick="toggleAuthMode('signup')">Create Account</div>
            </div>
            
            <form id="auth-form" onsubmit="handleAuth(event)" novalidate>
                <div class="input-group">
                    <label>Email Address</label>
                    <input type="email" id="auth-email" placeholder="student@college.edu" required>
                    <i class="fas fa-envelope input-icon"></i>
                </div>
                
                <div class="input-group">
                    <label>Password</label>
                    <div class="password-wrapper">
                        <input type="password" id="auth-password" placeholder="••••••••" required>
                        <i class="fas fa-lock input-icon"></i>
                        <i class="fas fa-eye password-toggle" id="togglePassword" onclick="window.togglePasswordVisibility()"></i>
                    </div>
                </div>
                
                <div style="text-align:right; margin-bottom:1.5rem;" id="forgot-pass-container">
                    <button type="button" onclick="window.handleResetPassword()" style="background:none; border:none; font-size:0.85rem; color:var(--primary); cursor:pointer; font-weight:500;">Forgot Password?</button>
                </div>

                <button type="submit" class="auth-btn-submit" id="auth-btn">Login</button>
            </form>

            <!-- SWITCH LINKS -->
            <div id="switch-to-signup" class="auth-bottom-link" style="display:block;">
                Don't have an account? <a onclick="toggleAuthMode('signup')">Create One</a>
            </div>
            <div id="switch-to-login" class="auth-bottom-link" style="display:none;">
                Already have an account? <a onclick="toggleAuthMode('login')">Login</a>
            </div>

            <div style="margin-top: 1rem; font-size: 0.85rem; color: var(--text-muted);">
                <a href="#" onclick="document.getElementById('auth-overlay').classList.remove('active')">Continue as Guest</a>
            </div>
        </div>
    </div>

    <!-- Mobile Navigation -->
    <nav class="mobile-nav">
        <div class="mobile-nav-item active" id="mob-dashboard" onclick="switchTab('dashboard')"><i class="fas fa-home"></i><span>Home</span></div>
        <div class="mobile-nav-item" id="mob-courses" onclick="switchTab('courses')"><i class="fas fa-book"></i><span>Courses</span></div>
        <div class="mobile-nav-item" id="mob-focus" onclick="switchTab('focus')"><i class="fas fa-clock"></i><span>Focus</span></div>
        <div class="mobile-nav-item" id="mob-achievements" onclick="switchTab('achievements')"><i class="fas fa-trophy"></i><span>Awards</span></div>
        <div class="mobile-nav-item" id="mob-profile" onclick="switchTab('profile')"><i class="fas fa-user"></i><span>Profile</span></div>
    </nav>

    <div class="app-wrapper">
        <aside class="sidebar">
            <div class="brand"><i class="fas fa-graduation-cap"></i><span>Achieve-mate</span></div>
            <div class="nav-item active" id="nav-dashboard" onclick="switchTab('dashboard')"><i class="fas fa-chart-pie"></i> Dashboard</div>
            <div class="nav-item" id="nav-courses" onclick="switchTab('courses')"><i class="fas fa-play-circle"></i> My Courses</div>
            <div class="nav-item" id="nav-focus" onclick="switchTab('focus')"><i class="fas fa-stopwatch"></i> Focus Mode</div>
            <div class="nav-item" id="nav-achievements" onclick="switchTab('achievements')"><i class="fas fa-trophy"></i> Achievements</div>
            <div class="nav-item" id="nav-profile" onclick="switchTab('profile')"><i class="fas fa-user-circle"></i> Profile</div>
            
            <div class="sidebar-footer">
                <div>Contact Developer</div>
                <a href="https://www.linkedin.com/in/deepak-kumar-jha-390694281/" target="_blank" class="creator-link">
                    <i class="fab fa-linkedin"></i> LinkedIn
                </a>
            </div>
        </aside>

        <main class="main-content">
            <header class="page-header">
                <div class="header-left">
                    <div class="greeting">
                        <h1 id="greetingText">Good Morning!</h1>
                        <p id="dateDisplay" style="color:var(--text-muted); font-size:0.9rem;">Loading...</p>
                    </div>
                </div>
                <div class="header-right">
                    <button id="headerLoginBtn" class="header-login-btn" onclick="document.getElementById('auth-overlay').classList.add('active')">
                        <i class="fas fa-sign-in-alt"></i> Login
                    </button>

                    <div id="headerUserBadge" class="user-badge-header" onclick="switchTab('profile')">
                        <div class="user-badge-avatar" id="headerUserInitials">U</div>
                        <div class="user-badge-name" id="headerUserName">User</div>
                    </div>

                    <div class="streak-badge" onclick="switchTab('profile')">
                        <i class="fas fa-fire" style="color: var(--accent)"></i>
                        <div class="streak-count" id="headerStreak">0</div>
                    </div>
                </div>
            </header>

            <!-- DASHBOARD -->
            <div id="dashboard-view" class="view-section">
                <div class="grid-dashboard">
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- DASHBOARD LEVEL CARD -->
                        <div class="card" style="background: var(--bg-card); border: 1px solid var(--primary); color: white;">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div>
                                    <div style="font-size: 0.8rem; opacity: 0.9; text-transform: uppercase; letter-spacing: 1px; color: var(--primary);">Current Level</div>
                                    <div style="font-size: 2rem; font-weight: 700; font-family: var(--font-heading);" id="dashboardLevelDisplay">1</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-size: 0.9rem; font-weight: 600;" id="dashboardXPDisplay">0 XP</div>
                                    <div style="font-size: 0.75rem; opacity: 0.8; color: var(--text-muted);">Keep pushing!</div>
                                </div>
                            </div>
                            <div style="height: 6px; background: rgba(255,255,255,0.1); border-radius: 3px; margin-top: 10px; overflow: hidden;">
                                <div id="dashboardLevelBar" style="height: 100%; background: var(--primary); width: 0%; transition: width 1s ease;"></div>
                            </div>
                        </div>

                        <div class="card">
                            <div class="card-title">
                                <div class="card-title-group">
                                    <i class="fas fa-tasks"></i>
                                    <span>Today's Priority</span>
                                </div>
                                <button class="btn-icon-only" onclick="openModal('manageGoalsModal')"><i class="fas fa-pencil-alt"></i></button>
                            </div>
                            <div id="dashboardGoalsList"></div>
                            <div id="emptyGoalsMsg" style="text-align:center; color:var(--text-muted); padding:1rem; font-size:0.9rem; display:none;">No tasks set. Tap the pencil to add.</div>
                        </div>
                        <div class="card">
                            <div class="card-title">
                                <div class="card-title-group"><i class="fas fa-chart-bar"></i> 7-Day Consistency</div>
                            </div>
                            <div class="graph-container" id="consistencyGraph"></div>
                        </div>
                    </div>

                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="card">
                            <div class="card-title">
                                <div class="card-title-group"><i class="fas fa-chart-line"></i> Progress</div>
                            </div>
                            <div style="display: flex; justify-content: space-around; text-align: center; padding: 10px 0;">
                                <div style="cursor: pointer;" onclick="switchTab('courses')">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="topicPct">0%</div>
                                    <div style="font-size: 0.9rem; color: var(--text-muted);">Courses</div>
                                </div>
                                <div style="cursor: pointer;" onclick="openModal('manageGoalsModal')">
                                    <div style="font-size: 2rem; font-weight: 700; color: var(--accent);" id="goalPct">0%</div>
                                    <div style="font-size: 0.9rem; color: var(--text-muted);">Goals</div>
                                </div>
                            </div>
                        </div>
                        <div class="card" onclick="switchTab('achievements')" style="cursor:pointer; background: linear-gradient(135deg, var(--bg-card), rgba(251, 191, 36, 0.1)); border-color: rgba(251, 191, 36, 0.3);">
                            <div class="card-title" style="color: var(--accent);">
                                <div class="card-title-group"><i class="fas fa-crown"></i> Recent Victory</div>
                            </div>
                            <div id="recentBadgeContent">Loading...</div>
                        </div>
                    </div>
                </div>

                <!-- INSTALL APP BANNER (Mobile Footer) -->
                <div id="installAppBanner" class="install-banner" onclick="installApp()">
                    <div style="display:flex; align-items:center; gap:12px;">
                        <div class="install-icon-circle"><i class="fas fa-download"></i></div>
                        <div>
                            <div class="install-text">Install App</div>
                            <div class="install-sub">Add to home screen for better experience</div>
                        </div>
                    </div>
                    <button onclick="dismissInstallBanner(event)" style="background:none; border:none; color:white; opacity:0.8; font-size:1.2rem;">&times;</button>
                </div>
            </div>

            <!-- COURSES -->
            <div id="courses-view" class="view-section" style="display: none;">
                <div class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <h2 style="font-family: var(--font-heading); font-size: 1.25rem;">Learning Playlists</h2>
                        <button class="btn btn-primary btn-sm" onclick="openModal('addPlaylistModal')"><i class="fas fa-plus"></i> Add Course</button>
                    </div>
                    
                    <!-- NEW SEARCH BAR -->
                    <div class="search-wrapper" style="margin-bottom: 1rem; position: relative;">
                        <i class="fas fa-search" style="position: absolute; left: 15px; top: 50%; transform: translateY(-50%); color: var(--text-muted);"></i>
                        <input type="text" id="courseSearch" placeholder="Search courses..." oninput="renderPlaylists()" style="padding-left: 40px; background: var(--bg-body); border: 1px solid var(--border); border-radius: 20px;">
                    </div>

                    <div class="course-filter-container">
                        <button class="course-tab active" onclick="filterCourses('all', this)">All</button>
                        <button class="course-tab" onclick="filterCourses('active', this)">In Progress</button>
                        <button class="course-tab" onclick="filterCourses('completed', this)">Completed</button>
                    </div>
                    <div id="playlistsContainer" class="courses-grid"></div>
                </div>
            </div>

            <!-- FOCUS -->
            <div id="focus-view" class="view-section" style="display: none;">
                <div class="grid-2">
                    <div class="card">
                        <div class="card-title" style="justify-content: center;">Focus Session</div>
                        <input type="text" id="focusTaskInput" placeholder="What are you working on?" style="text-align: center; margin-bottom: 1.5rem;">
                        <label style="display:block; text-align:center; color:var(--text-muted); margin-bottom:0.5rem;">Duration (Minutes)</label>
                        <input type="number" id="customFocusTime" value="25" style="text-align:center; margin-bottom:1rem; width:80px; margin-left:auto; margin-right:auto; display:block;">
                        <div style="display: flex; justify-content: center; gap: 10px; margin-bottom: 1.5rem;">
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('customFocusTime').value=25">25m</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('customFocusTime').value=45">45m</button>
                            <button class="btn btn-secondary btn-sm" onclick="document.getElementById('customFocusTime').value=60">60m</button>
                        </div>
                        <button class="btn btn-primary" style="width:100%" onclick="startFullScreenFocus()">Start Focus</button>
                    </div>
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-group">Recent Sessions</div>
                        </div>
                        <div id="focusHistoryList" style="max-height: 300px; overflow-y: auto;"></div>
                    </div>
                </div>
            </div>

            <!-- AWARDS -->
            <div id="achievements-view" class="view-section" style="display: none;">
                <div class="card">
                    <div class="card-title">
                        <div class="card-title-group">Badges & Milestones</div>
                        <span id="badgeCount" style="color:var(--accent)">0 / 17</span>
                    </div>
                    <div class="ach-filters">
                        <button class="ach-filter-btn active" onclick="filterBadges('all', this)">All</button>
                        <button class="ach-filter-btn" onclick="filterBadges('streak', this)">Streak</button>
                        <button class="ach-filter-btn" onclick="filterBadges('playlist', this)">Courses</button>
                        <button class="ach-filter-btn" onclick="filterBadges('focus', this)">Focus</button>
                    </div>
                    <div class="achievements-grid" id="achievementsGrid"></div>
                </div>
            </div>

            <!-- PROFILE (FIXED LAYOUT) -->
            <div id="profile-view" class="view-section" style="display: none;">
                <div class="card" style="display:flex; align-items:center; gap:1.5rem; background: linear-gradient(to right, var(--bg-card), rgba(99,102,241,0.1));">
                    <div style="width:70px; height:70px; border-radius:50%; background:var(--primary); color:white; display:flex; align-items:center; justify-content:center; font-size:2rem; font-weight:700; flex-shrink:0;" id="profilePic">U</div>
                    <div style="overflow: hidden;">
                        <h2 id="profileName" style="line-height:1.2; font-size:1.2rem; word-wrap: break-word;">Guest User</h2>
                        <p id="profileEmail" style="color:var(--text-muted); font-size:0.9rem; word-wrap: break-word;">Not logged in</p>
                        <p id="verificationStatus" style="color:var(--accent); font-size:0.8rem; display:none;">Email not verified</p>
                    </div>
                </div>

                <!-- LEVEL CIRCLE -->
                <div class="level-container" style="text-align:center;">
                    <div class="level-circle-container">
                        <div class="level-circle">
                            <svg viewBox="0 0 100 100">
                                <circle class="level-circle-bg" cx="50" cy="50" r="45"></circle>
                                <circle class="level-circle-fg" id="levelCircleFg" cx="50" cy="50" r="45"></circle>
                            </svg>
                            <div class="level-circle-content">
                                <div class="level-number-large" id="levelTitle">1</div>
                                <div class="level-label-small">LEVEL</div>
                            </div>
                        </div>
                    </div>
                    <h3 style="margin-bottom:5px; color:var(--primary);" id="xpDisplay">0 XP</h3>
                    <p class="xp-text" id="xpToNext">500 XP to Level 2</p>
                    <p class="xp-text" id="motivationalQuote" style="margin-top:10px; font-style:italic; color:var(--text-main);">Keep growing!</p>
                </div>

                <div class="grid-profile">
                    <div class="card">
                        <div class="cal-header">
                            <button class="btn-icon-only btn-sm" onclick="changeMonth(-1)"><i class="fas fa-chevron-left"></i></button>
                            <span id="calMonthYear"></span>
                            <button class="btn-icon-only btn-sm" onclick="changeMonth(1)"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="cal-grid" id="calGrid"></div>
                        <div style="margin-top:1rem; font-size:0.8rem; color:var(--text-muted); text-align:center;">Select date to view activity</div>
                    </div>
                    
                    <div class="card">
                        <div class="card-title">
                            <div class="card-title-group">Activity Log <span id="selectedDateDisplay" style="font-size:0.9rem; color:var(--primary)">Today</span></div>
                        </div>
                        <div id="activityLogContainer" style="height:300px; overflow-y:auto;">
                            <div style="text-align:center; padding:2rem; color:var(--text-muted);">Click a date on the calendar to view details.</div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-title">
                        <div class="card-title-group">Account Settings</div>
                    </div>
                    <div class="settings-grid">
                        <button class="btn btn-secondary" onclick="exportData()"><i class="fas fa-download"></i> Export</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('importFile').click()"><i class="fas fa-upload"></i> Import</button>
                        <button class="btn btn-secondary" onclick="document.getElementById('welcome-overlay').classList.add('active')"><i class="fas fa-question-circle"></i> Guide</button>
                        <button class="btn btn-secondary" onclick="if(confirm('Clear all local data?')) { localStorage.clear(); location.reload(); }"><i class="fas fa-trash"></i> Reset</button>
                        <button class="btn btn-secondary" onclick="window.location.href='mailto:support@achievemate.com'"><i class="fas fa-bug"></i> Report</button>
                        <button class="btn btn-secondary" onclick="window.open('https://www.linkedin.com/in/deepak-kumar-jha-390694281/', '_blank')"><i class="fab fa-linkedin"></i> Dev</button>
                        <button id="installAppBtnMobile" class="btn btn-primary" style="display:none; background: linear-gradient(45deg, var(--primary), #818cf8);" onclick="installApp()"><i class="fas fa-download"></i> Install App</button>
                        <button class="btn btn-danger" id="logoutBtn" style="display:none;" onclick="window.logoutUser()">Logout</button>
                    </div>
                    <input type="file" id="importFile" style="display: none;" accept=".json" onchange="importData(this)">
                </div>
            </div>

        </main>
    </div>

    <!-- Firebase Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail, sendEmailVerification, setPersistence, browserLocalPersistence, inMemoryPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBBuXEgTrEbAkj-BN_VSSYoVDx5e51fw4A",
            authDomain: "achieve-mate.firebaseapp.com",
            projectId: "achieve-mate",
            storageBucket: "achieve-mate.firebasestorage.app",
            messagingSenderId: "209711943902",
            appId: "1:209711943902:web:e8df445f14cc5c9b6eb24f"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // PERSISTENCE
        setPersistence(auth, browserLocalPersistence).catch((error) => {
            console.warn("Persistence error:", error);
        });

        window.showToast = function(msg, type = 'info') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            let icon = type === 'error' ? 'fa-exclamation-circle' : type === 'success' ? 'fa-check-circle' : 'fa-info-circle';
            toast.innerHTML = `<i class="fas ${icon}"></i> <span>${msg}</span>`;
            container.appendChild(toast);
            setTimeout(() => { toast.style.animation = 'fadeOut 0.3s forwards'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        window.handleAuth = async (e) => {
            if(e) e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const pass = document.getElementById('auth-password').value;
            const isSignup = document.getElementById('tab-signup').classList.contains('active');
            const btn = document.getElementById('auth-btn');
            const originalText = isSignup ? "Create Account" : "Login";
            
            btn.textContent = "Processing...";
            btn.disabled = true;
            btn.style.opacity = "0.7";

            const safetyTimeout = setTimeout(() => {
                if(btn.disabled) {
                    btn.textContent = originalText;
                    btn.disabled = false;
                    btn.style.opacity = "1";
                    window.showToast("Request timed out. Please check connection.", "error");
                }
            }, 15000);

            try {
                if (isSignup) {
                    const userCredential = await createUserWithEmailAndPassword(auth, email, pass);
                    await sendEmailVerification(userCredential.user);
                    await signOut(auth);
                    window.showToast("Account created! Please verify email.", "success");
                    window.toggleAuthMode('login');
                } else {
                    await signInWithEmailAndPassword(auth, email, pass);
                }
            } catch (err) {
                console.error("Auth Error:", err);
                let msg = "Something went wrong.";
                if(err.code === 'auth/email-already-in-use') msg = "Email already in use.";
                else if(err.code === 'auth/wrong-password' || err.code === 'auth/invalid-credential' || err.code === 'auth/user-not-found') msg = "Wrong email or password.";
                else if(err.code === 'auth/weak-password') msg = "Password too weak (min 6 chars).";
                else if(err.code === 'auth/invalid-email') msg = "Invalid email address.";
                else if(err.code === 'auth/network-request-failed') msg = "Network error. Check connection.";
                window.showToast(msg, "error");
            } finally {
                clearTimeout(safetyTimeout);
                btn.textContent = originalText;
                btn.disabled = false;
                btn.style.opacity = "1";
            }
        };

        window.handleResetPassword = async () => {
            const email = document.getElementById('auth-email').value;
            if (!email) return window.showToast("Enter email in the box first.", "error");
            try { await sendPasswordResetEmail(auth, email); window.showToast("Reset link sent!", "success"); } catch(e){ window.showToast(e.message, "error"); }
        };

        window.logoutUser = () => signOut(auth).then(() => location.reload());

        onAuthStateChanged(auth, (user) => {
            if (user) {
                if (!user.emailVerified) {
                    window.showToast("Please verify your email first.", "error");
                    signOut(auth);
                    return;
                }
                document.getElementById('auth-overlay').classList.remove('active');
                updateUserUI(user);
                loadDataFromCloud(user.uid);
            } else {
                resetUserUI();
            }
        });

        function updateUserUI(user) {
            const name = user.displayName || user.email.split('@')[0];
            const initial = name[0].toUpperCase();
            setText('profileName', name);
            setText('profileEmail', user.email);
            setText('profilePic', initial);
            const headerBtn = document.getElementById('headerLoginBtn');
            const headerBadge = document.getElementById('headerUserBadge');
            if(headerBtn) headerBtn.style.display = 'none';
            if(headerBadge) { headerBadge.style.display = 'flex'; setText('headerUserInitials', initial); setText('headerUserName', name); }
            const vStat = document.getElementById('verificationStatus');
            if(vStat) vStat.style.display = 'none';
            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) logoutBtn.style.display = 'inline-flex';
        }

        function resetUserUI() {
            setText('profileName', "Guest User");
            setText('profileEmail', "Not logged in");
            setText('profilePic', "U");
            const headerBtn = document.getElementById('headerLoginBtn');
            const headerBadge = document.getElementById('headerUserBadge');
            if(headerBtn) headerBtn.style.display = 'flex';
            if(headerBadge) headerBadge.style.display = 'none';
            const logoutBtn = document.getElementById('logoutBtn');
            if(logoutBtn) logoutBtn.style.display = 'none';
        }

        function setText(id, val) { const el = document.getElementById(id); if(el) el.textContent = val; }

        async function loadDataFromCloud(uid) {
            const docRef = doc(db, "users", uid);
            try {
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    window.appData = docSnap.data();
                    if(!window.appData.xp) window.appData.xp = 0;
                    if(!window.appData.level) window.appData.level = 1;
                    if(window.refreshUI) window.refreshUI();
                } else {
                    window.saveCloudData();
                }
            } catch (e) { console.error(e); }
        }

        window.saveCloudData = async () => {
            if (auth.currentUser && window.appData) {
                await setDoc(doc(db, "users", auth.currentUser.uid), window.appData);
            }
        };
    </script>

    <!-- Main Logic -->
    <script>
        window.appData = { playlists: [], dailyGoals: [], streak: 0, lastActive: null, history: {}, focusLogs: [], totalFocusTime: 0, isNewUser: true, xp: 0, level: 1 };
        let currentBadgeFilter = 'all';
        let currentCourseFilter = 'all';
        let calDate = new Date();
        let focusInterval = null;
        let currentTab = 'dashboard';
        let openPlaylistId = null; 

        /* --- INSTALL APP LOGIC (PWA) --- */
        let deferredPrompt;
        const installBanner = document.getElementById('installAppBanner');
        const isIos = () => /iphone|ipad|ipod/.test(window.navigator.userAgent.toLowerCase());
        const isInStandaloneMode = () => ('standalone' in window.navigator) && (window.navigator.standalone);

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if(window.innerWidth <= 768) {
                installBanner.style.display = 'flex';
            }
        });

        window.installApp = async () => {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                const { outcome } = await deferredPrompt.userChoice;
                deferredPrompt = null;
                if(outcome === 'accepted') installBanner.style.display = 'none';
            } else {
                if(isIos()) document.getElementById('ios-install-guide').style.display = 'block';
                else document.getElementById('android-manual-guide').style.display = 'block';
            }
        }
        
        window.dismissInstallBanner = (e) => {
            if(e) e.stopPropagation();
            installBanner.style.display = 'none';
        }
        
        if (isIos() && !isInStandaloneMode()) {
            setTimeout(() => document.getElementById('ios-install-guide').style.display = 'block', 2000);
        }

        window.togglePasswordVisibility = function() {
            const input = document.getElementById('auth-password');
            const icon = document.getElementById('togglePassword');
            if (input.type === "password") { input.type = "text"; icon.classList.remove('fa-eye'); icon.classList.add('fa-eye-slash'); } 
            else { input.type = "password"; icon.classList.remove('fa-eye-slash'); icon.classList.add('fa-eye'); }
        }

        function init() {
            const local = localStorage.getItem('achieveMate_v12');
            if(local) window.appData = JSON.parse(local);
            if(!window.appData.xp) window.appData.xp = 0;
            if(!window.appData.level) window.appData.level = 1;
            
            if(window.appData.isNewUser) document.getElementById('welcome-overlay').classList.add('active');
            
            updateGreeting();
            refreshUI();
            updateActiveTabUI('dashboard');
        }
        
        window.closeWelcomeGuide = function() {
            document.getElementById('welcome-overlay').classList.remove('active');
            window.appData.isNewUser = false;
            window.saveData();
        }

        window.refreshUI = function() {
            renderGoals();
            renderConsistencyGraph();
            renderPlaylists();
            renderAchievements();
            renderCalendar();
            renderFocusHistory();
            updateXP();
            const streakEl = document.getElementById('headerStreak');
            if(streakEl) streakEl.textContent = window.appData.streak;
        }

        window.saveData = function() {
            localStorage.setItem('achieveMate_v12', JSON.stringify(window.appData));
            if(window.saveCloudData) window.saveCloudData();
        }

        function addXP(amount) {
            window.appData.xp += amount;
            if (window.appData.xp < 0) window.appData.xp = 0;
            
            if (amount > 0) {
                const float = document.createElement('div');
                float.className = 'floating-xp';
                float.textContent = `+${amount} XP`;
                float.style.left = '50%';
                float.style.top = '50%';
                float.style.transform = 'translate(-50%, -50%)';
                document.body.appendChild(float);
                setTimeout(() => float.remove(), 1500);

                const newLevel = Math.floor(window.appData.xp / 500) + 1;
                if(newLevel > window.appData.level) {
                    window.appData.level = newLevel;
                    window.showToast(`🎉 Level Up! You are now Level ${newLevel}`, 'success');
                    triggerConfetti();
                }
            } else {
                const currentLevel = Math.floor(window.appData.xp / 500) + 1;
                if(currentLevel < window.appData.level) window.appData.level = currentLevel;
            }
            updateXP();
            window.saveData();
        }

        function updateXP() {
            const xp = window.appData.xp || 0;
            const level = window.appData.level || 1;
            const nextLevelXP = level * 500;
            const currentLevelStart = (level - 1) * 500;
            const progress = ((xp - currentLevelStart) / 500) * 100;
            const clampedProgress = Math.max(0, Math.min(100, progress));

            const titleEl = document.getElementById('levelTitle');
            if(titleEl) titleEl.textContent = level;
            
            const xpDisplayEl = document.getElementById('xpDisplay');
            if(xpDisplayEl) xpDisplayEl.textContent = `${xp} XP`;
            
            const nextEl = document.getElementById('xpToNext');
            if(nextEl) nextEl.textContent = `${nextLevelXP - xp} XP to Level ${level + 1}`;

            const circleFg = document.getElementById('levelCircleFg');
            if(circleFg) {
                const offset = 283 - (283 * clampedProgress / 100); 
                circleFg.style.strokeDasharray = '283';
                circleFg.style.strokeDashoffset = offset;
            }

            const dashLevelEl = document.getElementById('dashboardLevelDisplay');
            if(dashLevelEl) dashLevelEl.textContent = level;
            const dashXpEl = document.getElementById('dashboardXPDisplay');
            if(dashXpEl) dashXpEl.textContent = `${xp} XP`;
            const dashBarEl = document.getElementById('dashboardLevelBar');
            if(dashBarEl) dashBarEl.style.width = `${clampedProgress}%`;
            if(dashBarEl) dashBarEl.style.backgroundColor = "var(--primary)";

            const quoteEl = document.getElementById('motivationalQuote');
            if(quoteEl) {
                const quotes = [
                    "Keep growing!", "You're doing great!", "Consistent effort pays off.", 
                    "Level up your skills!", "Almost there!", "Stay focused, stay sharp.",
                    "Success is a journey.", "One step at a time."
                ];
                quoteEl.textContent = quotes[level % quotes.length];
            }
        }

        // --- Navigation ---
        window.switchTab = function(id) {
            currentTab = id;
            document.querySelectorAll('.view-section').forEach(e => e.style.display = 'none');
            const view = document.getElementById(id + '-view');
            if(view) view.style.display = 'block';
            updateActiveTabUI(id);
        }

        function updateActiveTabUI(id) {
            document.querySelectorAll('.nav-item, .mobile-nav-item').forEach(e => e.classList.remove('active'));
            const pcNav = document.getElementById('nav-' + id);
            const mobNav = document.getElementById('mob-' + id);
            if(pcNav) pcNav.classList.add('active');
            if(mobNav) mobNav.classList.add('active');
        }

        window.toggleAuthMode = function(mode) {
            document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
            document.getElementById('tab-' + mode).classList.add('active');
            
            const container = document.getElementById('authTabsContainer');
            const btn = document.getElementById('auth-btn');
            const fp = document.getElementById('forgot-pass-container');
            const switchSignup = document.getElementById('switch-to-signup');
            const switchLogin = document.getElementById('switch-to-login');

            if(mode === 'signup') {
                container.classList.add('signup-active');
                btn.textContent = "Create Account";
                fp.style.display = 'none';
                switchSignup.style.display = 'none';
                switchLogin.style.display = 'block';
            } else {
                container.classList.remove('signup-active');
                btn.textContent = "Login";
                fp.style.display = 'block';
                switchSignup.style.display = 'block';
                switchLogin.style.display = 'none';
            }
        }

        // --- Goals Logic ---
        window.addGoal = function() {
            const txt = document.getElementById('newGoalInput').value.trim();
            if(!txt) return;
            window.appData.dailyGoals.push({ id: Date.now(), text: txt, done: false, date: new Date().toDateString() });
            document.getElementById('newGoalInput').value = '';
            window.saveData();
            window.refreshUI();
            renderManageGoalsList();
        }

        window.toggleGoal = function(id) {
            const g = window.appData.dailyGoals.find(x => x.id === id);
            if(g) {
                g.done = !g.done;
                const xpAmount = 20;
                if(g.done) { 
                    triggerConfetti(); 
                    updateStreak();
                    addXP(xpAmount); 
                    logActivity('Goal', g.text, xpAmount);
                } else {
                    addXP(-xpAmount);
                }
                window.saveData();
                window.refreshUI(); 
            }
        }

        window.deleteGoal = function(id) {
            window.appData.dailyGoals = window.appData.dailyGoals.filter(x => x.id !== id);
            window.saveData();
            window.refreshUI();
            renderManageGoalsList();
        }

        function renderGoals() {
            const today = new Date().toDateString();
            const list = document.getElementById('dashboardGoalsList');
            const goals = window.appData.dailyGoals.filter(g => g.date === today);
            const emptyMsg = document.getElementById('emptyGoalsMsg');
            
            if(list) {
                list.innerHTML = '';
                if(goals.length === 0) {
                    if(emptyMsg) emptyMsg.style.display = 'block';
                } else {
                    if(emptyMsg) emptyMsg.style.display = 'none';
                    goals.forEach(g => {
                        const div = document.createElement('div');
                        div.className = `priority-item ${g.done?'checked':''}`;
                        div.onclick = () => window.toggleGoal(g.id);
                        div.innerHTML = `<div class="priority-checkbox">${g.done?'<i class="fas fa-check"></i>':''}</div><div class="priority-text">${g.text}</div>`;
                        list.appendChild(div);
                    });
                }
            }
            const done = goals.filter(g=>g.done).length;
            const pctEl = document.getElementById('goalPct');
            if(pctEl) pctEl.textContent = goals.length ? Math.round((done/goals.length)*100)+'%' : '0%';
        }

        function renderManageGoalsList() {
            const today = new Date().toDateString();
            const list = document.getElementById('manageGoalsList');
            const goals = window.appData.dailyGoals.filter(g => g.date === today);
            if(list) {
                list.innerHTML = goals.map(g => `
                    <div style="display:flex; justify-content:space-between; padding:10px; border-bottom:1px solid var(--border);">
                        <span>${g.text}</span>
                        <button class="btn-icon-only" style="color:var(--danger)" onclick="deleteGoal(${g.id})"><i class="fas fa-trash"></i></button>
                    </div>
                `).join('');
            }
        }

        function renderConsistencyGraph() {
            const container = document.getElementById('consistencyGraph');
            if(!container) return;
            container.innerHTML = '';
            const days = ['S','M','T','W','T','F','S'];
            for(let i=6; i>=0; i--) {
                const d = new Date(); d.setDate(d.getDate() - i);
                const goals = window.appData.dailyGoals.filter(g => g.date === d.toDateString());
                const pct = goals.length ? (goals.filter(g=>g.done).length / goals.length)*100 : 0;
                container.innerHTML += `<div class="graph-col"><div style="height:100%; width:10px; background:rgba(255,255,255,0.05); border-radius:10px; display:flex; align-items:flex-end;"><div class="graph-bar" style="height:${pct}%"></div></div><div class="graph-label">${days[d.getDay()]}</div></div>`;
            }
        }

        // --- Courses Logic ---
        window.savePlaylist = function(e) {
            e.preventDefault();
            const videos = document.getElementById('plVideos').value.split('\n').filter(v=>v.trim()).map(v=>({id:Date.now()+Math.random(), title:v, done:false}));
            const link = document.getElementById('plLink').value;
            window.appData.playlists.push({ id:Date.now(), name:document.getElementById('plName').value, source:document.getElementById('plSource').value, link:link, videos });
            window.closeModal('addPlaylistModal'); 
            window.saveData();
            window.refreshUI();
        }

        window.openModal = function(id) { 
            document.getElementById(id).classList.add('active'); 
            if(id==='manageGoalsModal') renderManageGoalsList(); 
            if(id==='addPlaylistModal') document.getElementById('addCourseForm').reset();
        }
        window.closeModal = function(id) { document.getElementById(id).classList.remove('active'); }

        window.toggleVideo = function(plId, vId, event) {
            const pl = window.appData.playlists.find(p=>p.id===plId);
            const v = pl.videos.find(x=>x.id===vId);
            v.done = !v.done;
            const xpAmount = 50;
            
            if(v.done) { 
                triggerConfetti(); 
                updateStreak();
                addXP(xpAmount); 
                logActivity('Study', `${pl.name}: ${v.title}`, xpAmount);
            } else {
                addXP(-xpAmount);
            }
            
            window.saveData();
            
            const btn = event ? event.currentTarget : null;
            if(btn) {
                if(v.done) btn.classList.add('checked'); else btn.classList.remove('checked');
                const checkIcon = btn.querySelector('.priority-checkbox');
                if(checkIcon) checkIcon.innerHTML = v.done ? '<i class="fas fa-check"></i>' : '';
                
                const card = btn.closest('.course-card');
                if(card) {
                    const doneCount = pl.videos.filter(v=>v.done).length;
                    const totalCount = pl.videos.length;
                    const pct = totalCount ? Math.round((doneCount/totalCount)*100) : 0;
                    const bar = card.querySelector('.course-progress-area div div');
                    const text = card.querySelector('.progress-text span:last-child');
                    const meta = card.querySelector('.course-meta span');
                    
                    if(bar) bar.style.width = `${pct}%`;
                    if(text) text.textContent = `${pct}%`;
                    if(meta) meta.textContent = `${doneCount} / ${totalCount} Completed`;
                }
            }
        }

        window.openEditPlaylist = function(id) {
            const pl = window.appData.playlists.find(p=>p.id===id);
            document.getElementById('editPlId').value = id;
            document.getElementById('editPlName').value = pl.name;
            document.getElementById('editPlLink').value = pl.link || '';
            document.getElementById('editPlVideos').value = pl.videos.map(v=>v.title).join('\n');
            document.getElementById('editPlaylistModal').classList.add('active');
        }

        window.updatePlaylist = function() {
            const id = parseInt(document.getElementById('editPlId').value);
            const pl = window.appData.playlists.find(p=>p.id===id);
            pl.name = document.getElementById('editPlName').value;
            pl.link = document.getElementById('editPlLink').value;
            const lines = document.getElementById('editPlVideos').value.split('\n').filter(v=>v.trim());
            pl.videos = lines.map(title => {
                const existing = pl.videos.find(v => v.title === title);
                return existing ? existing : { id: Date.now()+Math.random(), title, done:false };
            });
            window.closeModal('editPlaylistModal'); window.saveData(); window.refreshUI();
        }

        window.deletePlaylist = function() {
            const id = parseInt(document.getElementById('editPlId').value);
            if(confirm("Delete this course?")) {
                window.appData.playlists = window.appData.playlists.filter(p=>p.id!==id);
                window.closeModal('editPlaylistModal'); window.saveData(); window.refreshUI();
            }
        }

        window.filterCourses = function(filter, btn) {
            currentCourseFilter = filter;
            document.querySelectorAll('.course-tab').forEach(b => b.classList.remove('active'));
            btn.classList.add('active');
            renderPlaylists();
        }

        window.toggleAccordion = function(id) {
            openPlaylistId = openPlaylistId === id ? null : id;
            renderPlaylists();
        }

        function renderPlaylists() {
            const div = document.getElementById('playlistsContainer');
            if(!div) return;
            div.innerHTML = '';
            let totalV=0, doneV=0;
            let filteredList = window.appData.playlists;
            
            const searchTerm = document.getElementById('courseSearch')?.value.toLowerCase() || '';
            if(searchTerm) {
                filteredList = filteredList.filter(p => p.name.toLowerCase().includes(searchTerm));
            }

            if(currentCourseFilter === 'active') filteredList = filteredList.filter(p => { const d=p.videos.filter(v=>v.done).length; return d>0 && d<p.videos.length; });
            if(currentCourseFilter === 'completed') filteredList = filteredList.filter(p => { const d=p.videos.filter(v=>v.done).length; return d===p.videos.length && p.videos.length>0; });
            
            window.appData.playlists.forEach(pl => { totalV += pl.videos.length; doneV += pl.videos.filter(v=>v.done).length; });
            const topicPct = document.getElementById('topicPct');
            if(topicPct) topicPct.textContent = totalV ? Math.round((doneV/totalV)*100)+'%' : '0%';

            if (filteredList.length === 0) { div.innerHTML = `<div style="text-align:center; color:var(--text-muted); grid-column: 1/-1; padding: 2rem;">No courses found.</div>`; return; }
            
            filteredList.forEach(pl => {
                const done = pl.videos.filter(v=>v.done).length;
                const total = pl.videos.length;
                const pct = total ? Math.round((done/total)*100) : 0;
                const linkBtn = pl.link ? `<a href="${pl.link}" target="_blank" class="course-edit-btn btn-link-external" onclick="event.stopPropagation()"><i class="fas fa-external-link-alt"></i></a>` : '';
                const isOpen = pl.id === openPlaylistId ? 'open' : '';

                div.innerHTML += `
                    <div class="course-card">
                        <div class="course-header" onclick="toggleAccordion(${pl.id})">
                            <div class="course-header-top">
                                <div class="course-title"><i class="fas fa-chevron-down" style="transform: ${isOpen ? 'rotate(180deg)' : 'rotate(0deg)'}"></i>${pl.name}</div>
                                <div class="course-badge">${pl.source}</div>
                            </div>
                            <div class="course-meta"><span>${done} / ${total} Completed</span></div>
                            <div class="course-actions-container">${linkBtn}<div class="course-edit-btn" onclick="event.stopPropagation(); openEditPlaylist(${pl.id})"><i class="fas fa-edit"></i></div></div>
                        </div>
                        <div class="course-progress-area">
                            <div style="height:6px; background:var(--bg-body); border-radius:3px; overflow:hidden;"><div style="height:100%; background:var(--success); width:${pct}%"></div></div>
                            <div class="progress-text"><span>Progress</span><span>${pct}%</span></div>
                        </div>
                        <div class="video-accordion ${isOpen}">
                            ${pl.videos.map(v => `<div class="priority-item ${v.done?'checked':''}" style="border-radius:0; border:none; border-bottom:1px solid var(--border);" onclick="toggleVideo(${pl.id}, ${v.id}, event)"><div class="priority-checkbox" style="width:18px; height:18px; font-size:10px;">${v.done?'<i class="fas fa-check"></i>':''}</div><div class="priority-text" style="font-size:0.9rem;">${v.title}</div></div>`).join('')}
                        </div>
                    </div>`;
            });
        }

        // --- Awards ---
        window.filterBadges = function(cat, btn) {
            currentBadgeFilter = cat;
            document.querySelectorAll('.ach-filter-btn').forEach(b=>b.classList.remove('active'));
            btn.classList.add('active');
            renderAchievements();
        }

        const BADGES = [
            { id: 's3', cat: 'streak', n: 'Streak 3', d: '3 Day Streak', t: 3, c: d=>d.streak },
            { id: 's7', cat: 'streak', n: 'Streak 7', d: '7 Day Streak', t: 7, c: d=>d.streak },
            { id: 's30', cat: 'streak', n: 'Streak 30', d: '30 Day Streak', t: 30, c: d=>d.streak },
            { id: 's50', cat: 'streak', n: 'Streak 50', d: '50 Day Streak', t: 50, c: d=>d.streak },
            { id: 's100', cat: 'streak', n: 'Streak 100', d: '100 Day Streak', t: 100, c: d=>d.streak },
            { id: 's150', cat: 'streak', n: 'Streak 150', d: '150 Day Streak', t: 150, c: d=>d.streak },
            { id: 's200', cat: 'streak', n: 'Streak 200', d: '200 Day Streak', t: 200, c: d=>d.streak },
            { id: 's365', cat: 'streak', n: 'Legend', d: '365 Day Streak', t: 365, c: d=>d.streak },
            { id: 'c1', cat: 'playlist', n: 'Creator', d: 'Create 1 Course', t: 1, c: d=>d.playlists.length },
            { id: 'f1', cat: 'playlist', n: 'Finisher', d: 'Finish 1 Course', t: 1, c: d=>d.playlists.filter(p=>p.videos.length>0 && p.videos.every(v=>v.done)).length },
            { id: 'f5', cat: 'playlist', n: 'Scholar', d: 'Finish 5 Courses', t: 5, c: d=>d.playlists.filter(p=>p.videos.length>0 && p.videos.every(v=>v.done)).length },
            { id: 'f10', cat: 'playlist', n: 'Master', d: 'Finish 10 Courses', t: 10, c: d=>d.playlists.filter(p=>p.videos.length>0 && p.videos.every(v=>v.done)).length },
            { id: 'f25', cat: 'playlist', n: 'Grandmaster', d: 'Finish 25 Courses', t: 25, c: d=>d.playlists.filter(p=>p.videos.length>0 && p.videos.every(v=>v.done)).length },
            { id: 't5', cat: 'focus', n: 'Focus 5', d: '5 Hours Focused', t: 300, c: d=>(d.totalFocusTime||0) },
            { id: 't10', cat: 'focus', n: 'Focus 10', d: '10 Hours Focused', t: 600, c: d=>(d.totalFocusTime||0) },
            { id: 't25', cat: 'focus', n: 'Focus 25', d: '25 Hours Focused', t: 1500, c: d=>(d.totalFocusTime||0) },
            { id: 't50', cat: 'focus', n: 'Focus 50', d: '50 Hours Focused', t: 3000, c: d=>(d.totalFocusTime||0) }
        ];

        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            if(!grid) return;
            grid.innerHTML = '';
            let mapped = BADGES.map(b => {
                const val = b.c(window.appData);
                const earned = val >= b.t;
                const pct = Math.min(100, Math.round((val/b.t)*100));
                return { ...b, earned, val, pct };
            });
            mapped.sort((a,b) => b.earned - a.earned);
            if(currentBadgeFilter !== 'all') mapped = mapped.filter(b => b.cat === currentBadgeFilter);

            mapped.forEach(b => {
                grid.innerHTML += `
                    <div class="ach-card ${b.earned?'earned':''}">
                        <div class="ach-icon"><i class="fas ${b.cat==='streak'?'fa-fire':b.cat==='focus'?'fa-clock':'fa-graduation-cap'}"></i></div>
                        <div class="ach-info" style="flex:1">
                            <h4>${b.n}</h4>
                            <p>${b.d}</p>
                            ${!b.earned ? `<div class="ach-progress"><div class="ach-fill" style="width:${b.pct}%"></div></div>` : '<div style="font-size:0.7rem; color:var(--success); margin-top:4px;"><i class="fas fa-check"></i> Unlocked</div>'}
                        </div>
                    </div>`;
            });

            const earnedCount = mapped.filter(b=>b.earned).length;
            const countEl = document.getElementById('badgeCount');
            if(countEl) countEl.textContent = `${earnedCount} / 17`;
            
            const lastEarned = mapped.find(b=>b.earned);
            const recentEl = document.getElementById('recentBadgeContent');
            if(recentEl) {
                if(lastEarned) {
                    recentEl.innerHTML = `<div style="display:flex; gap:15px; align-items:center;"><div style="font-size:2rem; color:var(--accent);"><i class="fas fa-trophy"></i></div><div><div style="font-weight:600">${lastEarned.n}</div><div style="font-size:0.8rem; color:var(--text-muted)">Unlocked</div></div></div>`;
                } else {
                    recentEl.innerHTML = `<div style="color:var(--text-muted);">Keep working to unlock badges!</div>`;
                }
            }
        }

        // --- Calendar & Profile ---
        window.changeMonth = function(dir) {
            calDate.setMonth(calDate.getMonth() + dir);
            renderCalendar();
        }

        function renderCalendar() {
            const y = calDate.getFullYear(), m = calDate.getMonth();
            const monthEl = document.getElementById('calMonthYear');
            if(monthEl) monthEl.textContent = calDate.toLocaleString('default', { month:'long', year:'numeric' });
            const grid = document.getElementById('calGrid');
            if(!grid) return;
            grid.innerHTML = ['S','M','T','W','T','F','S'].map(d=>`<div style="text-align:center; font-size:0.7rem; color:var(--text-muted);">${d}</div>`).join('');
            
            const firstDay = new Date(y, m, 1).getDay();
            const daysInMonth = new Date(y, m+1, 0).getDate();
            
            for(let i=0; i<firstDay; i++) grid.innerHTML += `<div></div>`;
            
            for(let i=1; i<=daysInMonth; i++) {
                const dString = new Date(y, m, i).toLocaleDateString('en-CA'); 
                const hasData = window.appData.history[dString];
                const isToday = new Date().toDateString() === new Date(y,m,i).toDateString();
                grid.innerHTML += `<div class="cal-day ${isToday?'today':''} ${hasData?'has-data':''}" onclick="showActivity('${dString}')">${i}${hasData ? '<div class="cal-dot"></div>' : ''}</div>`;
            }
        }

        window.showActivity = function(dateStr) {
            const dateEl = document.getElementById('selectedDateDisplay');
            if(dateEl) dateEl.textContent = new Date(dateStr).toDateString();
            const div = document.getElementById('activityLogContainer');
            const logs = window.appData.history[dateStr] || [];
            
            if(!logs.length) {
                div.innerHTML = `<div style="text-align:center; padding:2rem; color:var(--text-muted);">No activity recorded for this date.</div>`;
                return;
            }

            const studies = logs.filter(l => l.type === 'Study');
            const goals = logs.filter(l => l.type === 'Goal');
            const focus = logs.filter(l => l.type === 'Focus');
            
            const studyGroups = {};
            studies.forEach(s => {
                let [course, ...topic] = s.title.split(':');
                topic = topic.join(':').trim();
                const xp = s.xp ? `<span class="xp-pill">+${s.xp} XP</span>` : '';
                if (!course) return;
                if (!studyGroups[course.trim()]) studyGroups[course.trim()] = [];
                studyGroups[course.trim()].push({title: topic || "General Study", xp: xp});
            });

            let html = '';
            if(goals.length) html += `<div class="activity-group type-goal"><div class="group-header">Goals (${goals.length})</div><div class="group-items show">${goals.map(g=>`<div>${g.title}</div>`).join('')}</div></div>`;
            for (const [course, items] of Object.entries(studyGroups)) {
                html += `<div class="activity-group type-study"><div class="group-header">${course} (${items.length})</div><div class="group-items show">${items.map(t=>`<div>${t.title}</div>`).join('')}</div></div>`;
            }
            if(focus.length) html += `<div class="activity-group"><div class="group-header">Focus (${focus.length})</div><div class="group-items show">${focus.map(f=>`<div>${f.title}</div>`).join('')}</div></div>`;
            
            div.innerHTML = html;
        }

        function logActivity(type, title, xp = 0) {
            const d = new Date().toLocaleDateString('en-CA');
            if(!window.appData.history[d]) window.appData.history[d] = [];
            window.appData.history[d].unshift({ type, title, xp, time: new Date().toLocaleTimeString() });
            renderCalendar();
        }

        // --- Focus Mode ---
        window.startFullScreenFocus = function() {
            const task = document.getElementById('focusTaskInput').value || "Deep Work";
            const mins = parseInt(document.getElementById('customFocusTime').value) || 25;
            document.getElementById('overlayTask').textContent = task;
            document.getElementById('focus-overlay').classList.add('active');
            let secs = mins * 60;
            
            if(focusInterval) clearInterval(focusInterval);
            focusInterval = setInterval(() => {
                secs--;
                const m = Math.floor(secs / 60);
                const s = secs % 60;
                document.getElementById('overlayTimer').textContent = `${m}:${s<10?'0':''}${s}`;
                if(secs <= 0) {
                    window.stopFullScreenFocus();
                    alert("Session Complete!");
                    triggerConfetti();
                    window.appData.totalFocusTime = (window.appData.totalFocusTime||0) + mins;
                    
                    const xpAmount = mins * 5;
                    addXP(xpAmount); 
                    
                    window.appData.focusLogs.unshift({ date: new Date().toLocaleString(), task, duration: mins });
                    logActivity('Focus', `${mins}m: ${task}`, xpAmount);
                    window.saveData();
                    window.refreshUI();
                }
            }, 1000);
        }

        window.stopFullScreenFocus = function() {
            clearInterval(focusInterval);
            document.getElementById('focus-overlay').classList.remove('active');
        }

        function renderFocusHistory() {
            const historyList = document.getElementById('focusHistoryList');
            if(historyList) {
                historyList.innerHTML = window.appData.focusLogs.map(f => `
                    <div style="padding:10px; border-bottom:1px solid var(--border);">
                        <div style="font-weight:600">${f.task}</div>
                        <div style="font-size:0.8rem; color:var(--text-muted);">${f.duration}m • ${f.date}</div>
                    </div>
                `).join('');
            }
        }

        // --- Utilities ---
        function updateStreak() {
            const today = new Date().toDateString();
            if(window.appData.lastActive !== today) {
                const yest = new Date(); yest.setDate(yest.getDate()-1);
                if(window.appData.lastActive === yest.toDateString()) window.appData.streak++;
                else window.appData.streak = 1;
                window.appData.lastActive = today;
            }
        }

        function updateGreeting() {
            const h = new Date().getHours();
            document.getElementById('greetingText').textContent = h<12?"Good Morning!":h<18?"Good Afternoon!":"Good Evening!";
            document.getElementById('dateDisplay').textContent = new Date().toDateString();
        }
        
        function triggerConfetti() {
            for(let i=0; i<30; i++) {
                const c=document.createElement('div'); c.className='confetti';
                c.style.left=Math.random()*100+'vw'; c.style.backgroundColor=['#f00','#0f0','#00f','#ff0'][Math.floor(Math.random()*4)];
                c.style.animation=`confetti ${1+Math.random()}s linear`;
                document.body.appendChild(c); setTimeout(()=>c.remove(), 2000);
            }
        }

        window.exportData = function() {
            const a=document.createElement('a'); a.href="data:text/json;charset=utf-8,"+encodeURIComponent(JSON.stringify(window.appData));
            a.download="achieve_backup.json"; document.body.appendChild(a); a.click(); a.remove();
        }
        
        window.importData = function(input) {
            const f=input.files[0]; if(!f)return;
            const r=new FileReader(); r.onload=e=>{ try{ window.appData=JSON.parse(e.target.result); window.saveData(); alert("Success"); }catch(e){alert("Error");} };
            r.readAsText(f);
        }

        init();

    </script>
</body>
</html>
